<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Henchman UI</title>
    <!-- Bootstrap css -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-7s5uDGW3AHqw6xtJmNNtr+OBRJUlgkNJEo78P4b0yRw= sha512-nNo+yCHEyn0smMxSswnf/OnX6/KwJuZTlNZBjauKhTK0c+zT+q5JOCx0UFhXQ6rJR9jg6Es8gPuD2uZcYDLqSw==" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.6/cerulean/bootstrap.min.css" rel="stylesheet" integrity="sha256-Ucf/ylcKTNevYP6l7VNUhGLDRZPQs1+LsbbxuzMxUJM= sha512-FW2XqnqMwERwg0LplG7D64h8zA1BsxvxrDseWpHLq8Dg8kOBmLs19XNa9oAajN/ToJRRklfDJ398sOU+7LcjZA==" crossorigin="anonymous">

    <!-- Bootstrap js -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha256-KXn5puMvxCw+dAYznun+drMdG1IFl3agK0p/pqT9KAo= sha512-2e8qq0ETcfWRI4HJBzQiA3UoyFk6tbNyG+qSaIBZLyW9Xf3sWZHN/lxe9fTh1U45DpPf07yj94KsUHHWe4Yk1A==" crossorigin="anonymous"></script>

    <!-- Bootstrap angular.js -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>

    <!-- angular scripts -->
    <script>
      var myApp = angular.module('myApp', []);

      myApp.constant("HENCHMAN_API", {
        "url": "http://localhost:10010/v0/",
      })

      myApp.config(function($sceProvider) {
        $sceProvider.enabled(false);
      });

      myApp.controller('exampleController', function ($scope, $http, HENCHMAN_API) {
        $scope.filesList = {
          selected: { 
            name: "None",
            content: ""
          },
          files: []
        };
        $scope.fileOptions = {
          selected: "None",
          options: [
            "plans",
            "inventories",
            "tasks",
            "vars"
          ]
        };
        $scope.henchmanStdout = ""

        $scope.listFiles = function(fileType) {
          if ($scope.fileOptions.options.indexOf(fileType) >= 0)  {
            $http.get(HENCHMAN_API.url+fileType)
              .then(function(res) {
                  $scope.filesList.files = res.data.files;
                }, function(errRes) {
                  $scope.filesList.files = [];
                  //print alert with message
              });
          }
        }
        $scope.getFileInfo = function(fname) {
          $http.get(HENCHMAN_API.url+$scope.fileOptions.selected+"/"+fname)
            .then(function(res) {
                $scope.filesList.selected.content = res.data.content;
              }, function(errRes) {
                alert(errRes.data.message)
            });
        }
        $scope.updateFileContent = function(fname) {
          $http.put(
            HENCHMAN_API.url+$scope.fileOptions.selected+"/"+fname,
            {content: $scope.filesList.selected.content})
              .then(function(res) {
                  alert(res.data.message)
                }, function(errRes) {
                  alert(errRes.data.message)
              });
         }
         $scope.executePlan = function(planName, invName) {
           var getQuery = HENCHMAN_API.url+$scope.fileOptions.selected+"/exec/"+planName+"?inventory="+invName
           $http.get(getQuery)
            .then(function(res) {
                var checker = getStdout()
                console.log("here is" + checker)
                while (checker) {
                  checker = getStdout()
                }
              }, function(errRes) {
                alert(errRes.data.message)
            });
         }
         var getStdout = function() {
           var getQuery = HENCHMAN_API.url+$scope.fileOptions.selected+"/exec"
           $http.get(getQuery)
            .then(function(res) {
                $scope.henchmanStdout += res.data.data
                console.log($scope.henchmanStdout)
                return res.data.status
              }, function(errRes) {
                alert(errRes.data.message)
                return 0
            });
         }
      });
    </script>
  </head>
  <body ng-app="myApp">
    <div class="container" ng-controller="exampleController">
      <div class="row">

        <!-- options col -->
        <div class="col-lg-4">

          <!-- dropdown to select file type -->
          <h4>Select a file type<h4>
          <div class="dropdown">
            <a class="btn btn-default" data-toggle="dropdown" href="#">{{ fileOptions.selected }} <b class="caret"></b></a>
            <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownFileOptions">
              <li ng-repeat="option in fileOptions.options | orderBy:'option'">
                <a ng-click="fileOptions.selected = option; listFiles(option)">{{ option }}</a>
              </li>
            </ul>
          </div>

          <!-- dropdown to select file -->
          <h4>Select a file<h4>
          <div class="dropdown">
            <a class="btn btn-default" data-toggle="dropdown" href="#">{{ filesList.selected.name }} <b class="caret"></b></a>
            <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownFilesList">
              <li ng-repeat="file in filesList.files | orderBy:'file'">
                <a ng-click="filesList.selected.name = file; getFileInfo(file)">{{ file }}</a>
              </li>
            </ul>
          </div>

          <!-- button to save file -->
          <br>
          <button class="btn btn-default" ng-click="updateFileContent(filesList.selected.name)">save</button>

          <!-- button to execute plan -->
          <br>
          <br>
          <button ng-show="fileOptions.selected == 'plans' && filesList.selected.name != 'None'" class="btn btn-default" ng-click="executePlan(filesList.selected.name, 'testInventory.yaml')">execute</button>
        </div>

        <!-- shows the "text editor" -->
        <div class="col-lg-8">
          <textarea ng-model="filesList.selected.content" rows="30" cols="75">
            {{ filesList.selected.content }}
          </textarea>
        </div>
      </div>

      <!-- second row -->
      <div class="row">
          {{ henchmanStdout }}
      </div>
    </div>
  </body>
</html>
